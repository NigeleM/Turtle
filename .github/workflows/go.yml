name: Build and Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: '1.23'

    - name: Build the binary for macOS
      run: |
        # Build your macOS binary
        GOOS=darwin GOARCH=arm64 go build -o release/turtle-darwin-arm64

    - name: Create macOS Installer
      if: runner.os == 'macOS'
      run: |
        # Debugging step: List contents of the release directory to ensure the binary exists
        ls -l release

        # Ensure the pkgroot directory structure exists
        mkdir -p pkgroot/usr/local/bin

        # Copy the binary directly to /usr/local/bin (no subdirectory)
        cp release/turtle-darwin-arm64 pkgroot/usr/local/bin/turtle

        # Verify the binary is in the correct location
        ls -l pkgroot/usr/local/bin/

        # Set the correct permissions on the binary
        chmod 755 pkgroot/usr/local/bin/turtle

        # Create the package
        pkgbuild --root pkgroot/usr/local/bin/ --identifier com.genesys.turtle \
          --version 0.1.6 --install-location /usr/local/bin \
          --ownership recommended release/turtle.pkg

    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/turtle.pkg

    - name: Clean up
      run: |
        # Clean up any build artifacts
        rm -rf release pkgroot
